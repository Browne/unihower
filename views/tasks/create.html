{% extends '_default.html' %}

{% block custom_styles %}
<link rel="stylesheet" href="/vendor/eonasdan-bootstrap-datetimepicker/build/css/bootstrap-datetimepicker.min.css">
{% endblock %}

{% block main %}
<div class="container">
  <h2>New Task</h2>
  <div class="row">
    <div class="col-md-6">
      <div class="eisenhower-graph" data-x="{{ query.x | round(2) if query.x else 0 }}" data-y="{{ query.y | round(2) if query.y else 0 }}" data-graph-new-task="true"></div>
    </div>
    <div class="col-md-6">
      <form id="newTaskForm" action="/api/tasks" method="POST">
        <input type="hidden" id="_csrf" name="_csrf" value="{{ csrfToken }}">
        <input type="hidden" id="coordX" name="coordX" value="{{ query.x | round(2)}}">
        <input type="hidden" id="coordY" name="coordY" value="{{ query.y | round(2) }}">

        <div class="form-group">
          <label for="description">Description</label>
          <input type="text" class="form-control" id="description" name="description" placeholder="Something I need to do." required>
          <p class="help-block">A short description of your task e.g. "Write co600 report"</p>
        </div>

        <div class="form-group">
          <label for="dueDate">Due Date</label>
          <input type="text" class="form-control" name="dueDate" id="dueDate">
          <p class="help-block">Optionally set a due date for this task. e.g. "in three days"</p>
        </div>

        <div class="form-group">
          <label for="TopicId">Topic</label>
          <select class="form-control" name="TopicId" id="TopicId">
            <option value="">---</option>
            {% for topic in topics %}
            <option value="{{ topic.id }}"{{ ' selected' if topic.id == query.topic }}>{{ topic.name if topic.name else topic.description | truncate(70) }}</option>
            {% endfor %}
          </select>
          <p class="help-block">Optionally assign this task to a topic.</p>
        </div>

        <button type="submit" class="btn btn-success">Create</button>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block custom_scripts %}
<script src="/vendor/sugar/release/sugar.min.js"></script>
<script src="/vendor/moment/min/moment.min.js"></script>
<script src="/assets/js/graph.js"></script>
<script>
  /**
   * Returns true if date is valid and in the future.
   *
   * @param  {String} dateInput Date to check validity of.
   * @return {Boolean}          True if valid.
   */
  function validateDate( dateInput ) {
    var date = Date.future( dateInput ).valueOf();

    if( date ) {
      return moment( date ).isAfter();
    }

    return false;
  }

  /*
    Realtime due date validity indication
   */
  $( '#dueDate' ).on( 'keyup', function() {
    var valid = validateDate( $( this ).val() );

    if( ! $( this ).val() ) {
      valid = true;
    }

    if( valid ) {
      $( this ).parents( '.form-group' ).removeClass( 'has-error' ).addClass( 'has-success' );
    }
    else {
      $( this ).parents( '.form-group' ).addClass( 'has-error' ).removeClass( 'has-success' );
    }
  });

  $( '#dueDate' ).on( 'blur', function() {
    var valid = validateDate( $( this ).val() );

    if( $( this ).val() && !valid ) {
      return;
    }

    $( this ).parents( '.form-group' ).removeClass( 'has-error' ).removeClass( 'has-success' );
  });

  /*
    Set coordinates for plotting
   */
  $( 'form#newTaskForm #coordX' ).val( $( '.eisenhower-graph:first' ).attr( 'data-x' ) );
  $( 'form#newTaskForm #coordY' ).val( $( '.eisenhower-graph:first' ).attr( 'data-y' ) );

  // update plot location on click
  $( '.eisenhower-graph:first' ).on( 'click', function() {
    $( 'form#newTaskForm #coordX' ).val( $( this ).attr( 'data-x' ) );
    $( 'form#newTaskForm #coordY' ).val( $( this ).attr( 'data-y' ) );
  });

  /*
    Ajax submit form
   */
  $( 'form#newTaskForm' ).on( 'submit', function( event ) {
    event.preventDefault();
    // check we have a valid date
    if( $( this ).find( '#dueDate' ).val() && !validateDate( $( this ).find( '#dueDate' ).val() ) ) {
      window.alert( 'please enter a valid due date' );
      return false;
    }

    // convert date into pure js safe date
    if( $( this ).find( '#dueDate' ).val() ) {
      $( this ).find( '#dueDate' ).val( Date.future( $( this ).find( '#dueDate' ).val() ).toString() );
    }

    // send data to server
    $.ajax({
      type: 'POST',
      url: $( this ).attr( 'action' ),
      data: $( this ).serialize(),
      dataType: 'json'
    }).done( function( data ) {
      window.location.href = '/tasks/' + data.id;
    }).fail( function() {
      console.log( arguments );
    });

    return false;
  });

  /*
    Plot tasks from topics in gray + readonly
   */
  var topicPlots = [];

  function plotTopicTasks( tasks ) {
    tasks.forEach( function( task ) {
      var plot = eisenhowerGraph.plotTask( task, eisenhowerGraph.graphs[ 0 ], null, 0.4 );
      topicPlots.push( plot );
    });
  }

  $( '#TopicId' ).on( 'change', function() {
    topicPlots.forEach( function( plot ) {
      plot.remove();
    });

    $.getJSON( '/api/topics/' + $( this ).val() + '/tasks', plotTopicTasks );
  });

  $.getJSON( '/api/topics/' + $( '#TopicId' ).val() + '/tasks', plotTopicTasks );
</script>
{% endblock %}
